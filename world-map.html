<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive World Map - Global Health Disparities</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #2d3748;
            overflow-x: hidden;
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .nav-logo {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-logo i {
            color: #059669;
            font-size: 1.75rem;
        }

        .nav-back {
            color: #059669;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-back:hover {
            color: #047857;
            transform: translateX(-3px);
        }

        /* Header */
        .header {
            margin-top: 80px;
            padding: 2rem;
            text-align: center;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Map Container */
        .map-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 200px);
            min-height: 600px;
            background: white;
            overflow: hidden;
        }

        .map-svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .map-svg:active {
            cursor: grabbing;
        }

        /* Country Styles */
        .country {
            fill: #e2e8f0;
            stroke: #cbd5e0;
            stroke-width: 0.5;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .country:hover {
            stroke: #059669;
            stroke-width: 2;
            filter: brightness(1.1);
        }

        .country.selected {
            stroke: #2563eb;
            stroke-width: 3;
        }

        /* Data Colors */
        .gap-very-low { fill: #10b981; }
        .gap-low { fill: #34d399; }
        .gap-medium { fill: #fbbf24; }
        .gap-high { fill: #f59e0b; }
        .gap-very-high { fill: #ef4444; }
        .gap-critical { fill: #dc2626; }
        .gap-no-data { fill: #9ca3af; }

        /* Control Panel */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            z-index: 100;
            min-width: 300px;
        }

        .controls h3 {
            margin-bottom: 1rem;
            color: #2d3748;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .controls h3 i {
            color: #059669;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .control-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .control-select:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .map-btn {
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .map-btn:hover {
            border-color: #059669;
            color: #059669;
            background: #f0fff4;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            z-index: 100;
        }

        .legend h4 {
            margin-bottom: 1rem;
            color: #2d3748;
            font-size: 1rem;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-label {
            font-size: 0.875rem;
            color: #4a5568;
            font-weight: 500;
        }

        /* Info Panel */
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            z-index: 100;
            min-width: 280px;
            max-width: 350px;
            display: none;
        }

        .info-panel.active {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .info-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .info-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #718096;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .info-close:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .info-subtitle {
            color: #718096;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .info-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .metric {
            text-align: center;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-details {
            margin-top: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #4a5568;
        }

        .detail-value {
            font-weight: 600;
            color: #2d3748;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transform: translate(-50%, -100%);
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .tooltip.active {
            opacity: 1;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(30, 41, 59, 0.95);
        }

        /* Loading State */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #718096;
            z-index: 200;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #059669;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .controls, .legend, .info-panel {
                position: relative;
                margin: 1rem;
                width: calc(100% - 2rem);
                min-width: auto;
            }

            .info-panel {
                margin-top: 0;
            }

            .map-container {
                height: 400px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-container {
                padding: 0 1rem;
            }

            .nav-logo {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <i class="fas fa-globe-americas"></i>
                Global Health Map
            </a>
            <a href="index.html" class="nav-back">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
    </nav>

    <!-- Header -->
    <header class="header">
        <h1>Interactive Global Health Disparities Map</h1>
        <p>Explore mental health treatment gaps, economic impact, and healthcare resource distribution across 194 countries worldwide</p>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading world map and health data...</p>
        </div>

        <!-- Map Container -->
        <div class="map-container" id="map-container">
            <!-- Map Controls -->
            <div class="controls">
                <h3><i class="fas fa-sliders-h"></i> Map Controls</h3>
                
                <div class="control-group">
                    <label for="data-layer">Data Layer</label>
                    <select id="data-layer" class="control-select">
                        <option value="treatment-gap">Mental Health Treatment Gap</option>
                        <option value="economic-impact">Economic Impact (% GDP)</option>
                        <option value="healthcare-workers">Healthcare Workers per 1000</option>
                        <option value="hospital-beds">Hospital Beds per 1000</option>
                        <option value="health-expenditure">Health Expenditure (% GDP)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="disorder-type">Mental Health Disorder</label>
                    <select id="disorder-type" class="control-select">
                        <option value="overall">Overall Average</option>
                        <option value="depression">Depression</option>
                        <option value="anxiety">Anxiety Disorders</option>
                        <option value="bipolar">Bipolar Disorder</option>
                        <option value="schizophrenia">Schizophrenia</option>
                        <option value="substance-use">Substance Use Disorders</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="income-filter">Income Group Filter</label>
                    <select id="income-filter" class="control-select">
                        <option value="all">All Income Levels</option>
                        <option value="high">High Income</option>
                        <option value="upper-middle">Upper Middle Income</option>
                        <option value="lower-middle">Lower Middle Income</option>
                        <option value="low">Low Income</option>
                    </select>
                </div>

                <div class="map-controls">
                    <button class="map-btn" id="zoom-in" title="Zoom In">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="map-btn" id="zoom-out" title="Zoom Out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="map-btn" id="reset-zoom" title="Reset View">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="map-btn" id="fullscreen" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <h4>Treatment Gap Severity</h4>
                <div class="legend-item">
                    <div class="legend-color gap-very-low"></div>
                    <span class="legend-label">0-20% (Very Low)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gap-low"></div>
                    <span class="legend-label">20-40% (Low)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gap-medium"></div>
                    <span class="legend-label">40-60% (Medium)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gap-high"></div>
                    <span class="legend-label">60-80% (High)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gap-very-high"></div>
                    <span class="legend-label">80-95% (Very High)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gap-critical"></div>
                    <span class="legend-label">95%+ (Critical)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gap-no-data"></div>
                    <span class="legend-label">No Data</span>
                </div>
            </div>

            <!-- SVG Map -->
            <svg class="map-svg" id="world-map"></svg>

            <!-- Country Info Panel -->
            <div class="info-panel" id="info-panel">
                <div class="info-header">
                    <div>
                        <div class="info-title" id="info-country-name">Select a Country</div>
                        <div class="info-subtitle" id="info-country-region">Click on any country to view details</div>
                    </div>
                    <button class="info-close" id="info-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="info-metrics">
                    <div class="metric">
                        <div class="metric-value" id="info-treatment-gap">--</div>
                        <div class="metric-label">Treatment Gap</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="info-population">--</div>
                        <div class="metric-label">Population</div>
                    </div>
                </div>

                <div class="info-details">
                    <div class="detail-item">
                        <span class="detail-label">Income Group</span>
                        <span class="detail-value" id="info-income">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Region</span>
                        <span class="detail-value" id="info-region">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Healthcare Workers/1000</span>
                        <span class="detail-value" id="info-workers">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Health Expenditure (% GDP)</span>
                        <span class="detail-value" id="info-expenditure">--</span>
                    </div>
                </div>
            </div>

            <!-- Tooltip -->
            <div class="tooltip" id="tooltip"></div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="script.js"></script>
    <script>
        // Global variables
        let worldData = null;
        let healthData = null;
        let svg = null;
        let g = null;
        let path = null;
        let zoom = null;
        let currentDataLayer = 'treatment-gap';
        let currentDisorder = 'overall';
        let currentIncomeFilter = 'all';

        // Initialize the map
        async function initializeMap() {
            try {
                console.log('=ú Initializing world map...');
                
                // Load world topology and health data
                await Promise.all([
                    loadWorldData(),
                    loadHealthData()
                ]);

                // Setup map
                setupMap();
                renderMap();
                setupEventListeners();
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                console.log(' World map initialized successfully!');
                
            } catch (error) {
                console.error('L Error initializing map:', error);
                showError('Failed to load map data. Please refresh the page.');
            }
        }

        // Load world topology data
        async function loadWorldData() {
            try {
                // Use a public world topology dataset
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                if (!response.ok) throw new Error('Failed to load world data');
                
                worldData = await response.json();
                console.log('=Í World topology data loaded');
                
            } catch (error) {
                console.error('Error loading world data:', error);
                // Fallback to basic world data
                worldData = createBasicWorldData();
            }
        }

        // Load health data
        async function loadHealthData() {
            try {
                const response = await fetch('./datasets/mental-health-treatment-gaps.json?v=' + Date.now());
                if (!response.ok) throw new Error('Failed to load health data');
                
                healthData = await response.json();
                console.log('=Ê Health data loaded');
                
            } catch (error) {
                console.error('Error loading health data:', error);
                // Use sample data
                healthData = createSampleHealthData();
            }
        }

        // Setup SVG map
        function setupMap() {
            const container = document.getElementById('map-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select('#world-map')
                .attr('width', width)
                .attr('height', height);

            // Create projection
            const projection = d3.geoNaturalEarth1()
                .scale(width / 6.5)
                .translate([width / 2, height / 2]);

            path = d3.geoPath().projection(projection);

            // Setup zoom
            zoom = d3.zoom()
                .scaleExtent([0.5, 8])
                .on('zoom', handleZoom);

            svg.call(zoom);

            // Create main group
            g = svg.append('g');
        }

        // Render the map
        function renderMap() {
            if (!worldData || !healthData) return;

            const countries = topojson.feature(worldData, worldData.objects.countries);

            // Draw countries
            const countryPaths = g.selectAll('.country')
                .data(countries.features)
                .enter().append('path')
                .attr('class', 'country')
                .attr('d', path)
                .attr('data-name', d => d.properties.NAME || 'Unknown')
                .on('mouseover', handleCountryHover)
                .on('mouseout', handleCountryLeave)
                .on('click', handleCountryClick);

            // Apply initial coloring
            updateMapColors();
        }

        // Update map colors based on current data layer
        function updateMapColors() {
            d3.selectAll('.country')
                .attr('class', d => {
                    const countryName = d.properties.NAME || 'Unknown';
                    const colorClass = getCountryColorClass(countryName);
                    return `country ${colorClass}`;
                });
        }

        // Get color class for country based on data
        function getCountryColorClass(countryName) {
            const countryData = getCountryData(countryName);
            if (!countryData) return 'gap-no-data';

            let value;
            switch (currentDataLayer) {
                case 'treatment-gap':
                    value = countryData.treatmentGaps?.[currentDisorder] || countryData.treatmentGaps?.overall || 0;
                    break;
                case 'economic-impact':
                    value = countryData.economicImpact?.gdpPercentage || 0;
                    break;
                case 'healthcare-workers':
                    value = countryData.healthcareResources?.workersPerThousand || 0;
                    break;
                case 'hospital-beds':
                    value = countryData.healthcareResources?.bedsPerThousand || 0;
                    break;
                case 'health-expenditure':
                    value = countryData.healthExpenditure?.percentGDP || 0;
                    break;
                default:
                    value = 0;
            }

            // Return color class based on value ranges
            if (currentDataLayer === 'treatment-gap') {
                if (value >= 95) return 'gap-critical';
                if (value >= 80) return 'gap-very-high';
                if (value >= 60) return 'gap-high';
                if (value >= 40) return 'gap-medium';
                if (value >= 20) return 'gap-low';
                return 'gap-very-low';
            } else {
                // For other metrics, use inverted scale (higher is better)
                if (value >= 8) return 'gap-very-low';
                if (value >= 6) return 'gap-low';
                if (value >= 4) return 'gap-medium';
                if (value >= 2) return 'gap-high';
                if (value > 0) return 'gap-very-high';
                return 'gap-no-data';
            }
        }

        // Get country data from health dataset
        function getCountryData(countryName) {
            if (!healthData || !healthData.treatmentGapsByCountry) return null;
            
            // Try exact match first
            let data = healthData.treatmentGapsByCountry[countryName];
            if (data) return data;

            // Try fuzzy matching
            const countries = Object.keys(healthData.treatmentGapsByCountry);
            const match = countries.find(country => 
                country.toLowerCase().includes(countryName.toLowerCase()) ||
                countryName.toLowerCase().includes(country.toLowerCase())
            );

            return match ? healthData.treatmentGapsByCountry[match] : null;
        }

        // Handle country hover
        function handleCountryHover(event, d) {
            const countryName = d.properties.NAME || 'Unknown';
            const countryData = getCountryData(countryName);
            
            // Show tooltip
            const tooltip = document.getElementById('tooltip');
            let tooltipText = countryName;
            
            if (countryData) {
                const value = getCurrentValue(countryData);
                const unit = getValueUnit();
                tooltipText += `\n${value}${unit}`;
            } else {
                tooltipText += '\nNo data available';
            }

            tooltip.textContent = tooltipText;
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.classList.add('active');

            // Highlight country
            d3.select(event.target)
                .classed('selected', true);
        }

        // Handle country leave
        function handleCountryLeave(event, d) {
            // Hide tooltip
            document.getElementById('tooltip').classList.remove('active');

            // Remove highlight
            d3.select(event.target)
                .classed('selected', false);
        }

        // Handle country click
        function handleCountryClick(event, d) {
            const countryName = d.properties.NAME || 'Unknown';
            const countryData = getCountryData(countryName);
            
            showCountryInfo(countryName, countryData);
        }

        // Show country information panel
        function showCountryInfo(countryName, countryData) {
            const panel = document.getElementById('info-panel');
            
            // Update country name and region
            document.getElementById('info-country-name').textContent = countryName;
            
            if (countryData) {
                document.getElementById('info-country-region').textContent = countryData.region || 'Unknown Region';
                document.getElementById('info-treatment-gap').textContent = `${countryData.treatmentGaps?.overall || 0}%`;
                document.getElementById('info-population').textContent = formatNumber(countryData.population || 0);
                document.getElementById('info-income').textContent = countryData.incomeGroup || 'Unknown';
                document.getElementById('info-region').textContent = countryData.region || 'Unknown';
                document.getElementById('info-workers').textContent = countryData.healthcareResources?.workersPerThousand || '0';
                document.getElementById('info-expenditure').textContent = `${countryData.healthExpenditure?.percentGDP || 0}%`;
            } else {
                document.getElementById('info-country-region').textContent = 'No data available';
                document.getElementById('info-treatment-gap').textContent = '--';
                document.getElementById('info-population').textContent = '--';
                document.getElementById('info-income').textContent = '--';
                document.getElementById('info-region').textContent = '--';
                document.getElementById('info-workers').textContent = '--';
                document.getElementById('info-expenditure').textContent = '--';
            }

            panel.classList.add('active');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Data layer change
            document.getElementById('data-layer').addEventListener('change', (e) => {
                currentDataLayer = e.target.value;
                updateMapColors();
                updateLegend();
            });

            // Disorder type change
            document.getElementById('disorder-type').addEventListener('change', (e) => {
                currentDisorder = e.target.value;
                updateMapColors();
            });

            // Income filter change
            document.getElementById('income-filter').addEventListener('change', (e) => {
                currentIncomeFilter = e.target.value;
                filterCountriesByIncome();
            });

            // Map controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1.5);
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1 / 1.5);
            });

            document.getElementById('reset-zoom').addEventListener('click', () => {
                svg.transition().call(zoom.transform, d3.zoomIdentity);
            });

            document.getElementById('fullscreen').addEventListener('click', toggleFullscreen);

            // Info panel close
            document.getElementById('info-close').addEventListener('click', () => {
                document.getElementById('info-panel').classList.remove('active');
            });

            // Window resize
            window.addEventListener('resize', handleResize);
        }

        // Handle zoom
        function handleZoom(event) {
            g.attr('transform', event.transform);
        }

        // Handle window resize
        function handleResize() {
            const container = document.getElementById('map-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg.attr('width', width).attr('height', height);
            
            // Update projection
            const projection = d3.geoNaturalEarth1()
                .scale(width / 6.5)
                .translate([width / 2, height / 2]);

            path.projection(projection);
            
            // Redraw countries
            g.selectAll('.country').attr('d', path);
        }

        // Utility functions
        function getCurrentValue(countryData) {
            switch (currentDataLayer) {
                case 'treatment-gap':
                    return countryData.treatmentGaps?.[currentDisorder] || countryData.treatmentGaps?.overall || 0;
                case 'economic-impact':
                    return countryData.economicImpact?.gdpPercentage || 0;
                case 'healthcare-workers':
                    return countryData.healthcareResources?.workersPerThousand || 0;
                case 'hospital-beds':
                    return countryData.healthcareResources?.bedsPerThousand || 0;
                case 'health-expenditure':
                    return countryData.healthExpenditure?.percentGDP || 0;
                default:
                    return 0;
            }
        }

        function getValueUnit() {
            switch (currentDataLayer) {
                case 'treatment-gap':
                case 'economic-impact':
                case 'health-expenditure':
                    return '%';
                case 'healthcare-workers':
                case 'hospital-beds':
                    return '/1000';
                default:
                    return '';
            }
        }

        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toString();
        }

        function updateLegend() {
            // Update legend based on current data layer
            const legend = document.querySelector('.legend h4');
            const labels = {
                'treatment-gap': 'Treatment Gap Severity',
                'economic-impact': 'Economic Impact (% GDP)',
                'healthcare-workers': 'Healthcare Workers per 1000',
                'hospital-beds': 'Hospital Beds per 1000',
                'health-expenditure': 'Health Expenditure (% GDP)'
            };
            legend.textContent = labels[currentDataLayer] || 'Data Layer';
        }

        function filterCountriesByIncome() {
            d3.selectAll('.country')
                .style('opacity', d => {
                    if (currentIncomeFilter === 'all') return 1;
                    
                    const countryName = d.properties.NAME || 'Unknown';
                    const countryData = getCountryData(countryName);
                    
                    if (!countryData) return 0.3;
                    
                    const incomeGroup = countryData.incomeGroup?.toLowerCase() || '';
                    const filterGroup = currentIncomeFilter.toLowerCase();
                    
                    return incomeGroup.includes(filterGroup) ? 1 : 0.3;
                });
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.getElementById('map-container').requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showError(message) {
            const loading = document.getElementById('loading');
            loading.innerHTML = `
                <div style="color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        // Fallback data functions
        function createBasicWorldData() {
            // Basic world topology structure
            return {
                type: "Topology",
                objects: {
                    countries: {
                        type: "GeometryCollection",
                        geometries: []
                    }
                }
            };
        }

        function createSampleHealthData() {
            return {
                treatmentGapsByCountry: {
                    "United States": {
                        region: "North America",
                        incomeGroup: "High Income",
                        population: 331000000,
                        treatmentGaps: { overall: 45, depression: 43, anxiety: 47 },
                        economicImpact: { gdpPercentage: 4.2 },
                        healthcareResources: { workersPerThousand: 12.3, bedsPerThousand: 2.9 },
                        healthExpenditure: { percentGDP: 17.8 }
                    },
                    "Germany": {
                        region: "Europe",
                        incomeGroup: "High Income",
                        population: 83000000,
                        treatmentGaps: { overall: 32, depression: 30, anxiety: 34 },
                        economicImpact: { gdpPercentage: 3.1 },
                        healthcareResources: { workersPerThousand: 15.2, bedsPerThousand: 8.0 },
                        healthExpenditure: { percentGDP: 11.7 }
                    }
                }
            };
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeMap);
    </script>
</body>
</html>